import React, { useState, useMemo, useEffect } from 'react';
import { 
  Calculator, 
  TrendingUp, 
  Calendar, 
  Download, 
  FileText,
  CheckCircle2,
  Circle,
  Clock,
  Target,
  Home,
  PieChart,
  ArrowRightLeft,
  PiggyBank
} from 'lucide-react';

// --- Utility Functions ---

const formatCurrency = (value) => {
  return new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
    maximumFractionDigits: 0,
  }).format(value);
};

// Formatting Helper: Use full numbers for clarity as requested
const formatFullNumber = (number) => {
  return new Intl.NumberFormat('en-IN', {
    maximumFractionDigits: 0,
  }).format(number);
};

const formatCompactNumber = (number) => {
  return new Intl.NumberFormat('en-IN', {
    notation: "compact",
    maximumFractionDigits: 1
  }).format(number);
};

const amountToWords = (num) => {
  if (!num || num === 0) return '';
  
  const a = ['','One ','Two ','Three ','Four ', 'Five ','Six ','Seven ','Eight ','Nine ','Ten ','Eleven ','Twelve ','Thirteen ','Fourteen ','Fifteen ','Sixteen ','Seventeen ','Eighteen ','Nineteen '];
  const b = ['', '', 'Twenty','Thirty','Forty','Fifty', 'Sixty','Seventy','Eighty','Ninety'];

  const inWords = (n) => {
    if ((n = n.toString()).length > 9) return 'overflow';
    let n_array = ('000000000' + n).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
    if (!n_array) return; 
    let str = '';
    str += (n_array[1] != 0) ? (a[Number(n_array[1])] || b[n_array[1][0]] + ' ' + a[n_array[1][1]]) + 'Crore ' : '';
    str += (n_array[2] != 0) ? (a[Number(n_array[2])] || b[n_array[2][0]] + ' ' + a[n_array[2][1]]) + 'Lakh ' : '';
    str += (n_array[3] != 0) ? (a[Number(n_array[3])] || b[n_array[3][0]] + ' ' + a[n_array[3][1]]) + 'Thousand ' : '';
    str += (n_array[4] != 0) ? (a[Number(n_array[4])] || b[n_array[4][0]] + ' ' + a[n_array[4][1]]) + 'Hundred ' : '';
    str += (n_array[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n_array[5])] || b[n_array[5][0]] + ' ' + a[n_array[5][1]]) : '';
    return str;
  };

  return inWords(Math.floor(num));
};

// --- Neumorphic Components ---

const NeumorphicLayout = ({ children }) => (
  <div className="min-h-screen bg-[#E0E5EC] text-slate-600 font-sans flex items-center justify-center p-4 md:p-8">
    {children}
  </div>
);

const NeumorphicCard = ({ children, className = "" }) => (
  <div 
    className={`bg-[#E0E5EC] rounded-[30px] shadow-[9px_9px_16px_rgb(163,177,198,0.6),-9px_-9px_16px_rgba(255,255,255,0.5)] ${className}`}
  >
    {children}
  </div>
);

const NeumorphicInput = ({ 
  label, 
  value, 
  onChange, 
  type = "number", 
  prefix, 
  suffix,
  step = 1,
  isCalculated = false,
  helperText, 
  onFocus
}) => (
  <div className="mb-6">
    <div className="flex justify-between mb-2 px-1">
      <label className={`text-xs font-bold tracking-wider uppercase ${isCalculated ? 'text-emerald-500' : 'text-slate-500'}`}>
        {label} {isCalculated && "(Auto)"}
      </label>
    </div>
    <div 
      className={`
        relative flex items-center rounded-2xl px-4 py-3 transition-all
        ${isCalculated 
          ? 'bg-[#E0E5EC] shadow-[5px_5px_10px_#b8b9be,-5px_-5px_10px_#ffffff] border border-emerald-100/50' 
          : 'bg-[#E0E5EC] shadow-[inset_6px_6px_10px_0_rgba(163,177,198,0.7),inset_-6px_-6px_10px_0_rgba(255,255,255,0.8)]'
        }
      `}
    >
      {prefix && <span className="text-slate-400 mr-2 font-medium">{prefix}</span>}
      <input
        type={type}
        value={value}
        onChange={(e) => !isCalculated && onChange(e.target.value)}
        onFocus={onFocus}
        readOnly={isCalculated}
        step={step}
        className={`
          w-full bg-transparent outline-none text-lg font-bold text-slate-700 placeholder-slate-300
          ${isCalculated ? 'cursor-default text-emerald-600' : ''}
        `}
      />
      {suffix && <span className="text-slate-400 ml-2 text-sm font-medium">{suffix}</span>}
    </div>
    {helperText && (
      <p className="text-[10px] font-semibold text-emerald-600/70 mt-2 ml-2 tracking-wide h-3 leading-none truncate">
        {helperText}
      </p>
    )}
  </div>
);

const NeumorphicToggle = ({ options, value, onChange }) => (
  <div className="flex bg-[#E0E5EC] rounded-xl p-1 shadow-[inset_4px_4px_8px_#b8b9be,inset_-4px_-4px_8px_#ffffff] h-full items-center">
    {options.map((opt) => (
      <button
        key={opt.value}
        onClick={() => onChange(opt.value)}
        className={`
          flex-1 py-2 px-2 rounded-lg text-[10px] sm:text-xs font-bold uppercase tracking-wide transition-all duration-300 h-full flex items-center justify-center
          ${value === opt.value 
            ? 'bg-[#E0E5EC] text-emerald-500 shadow-[4px_4px_8px_#b8b9be,-4px_-4px_8px_#ffffff]' 
            : 'text-slate-400 hover:text-slate-500'
          }
        `}
      >
        {opt.label}
      </button>
    ))}
  </div>
);

const NeumorphicButton = ({ children, onClick, icon: Icon, className = "" }) => (
  <button
    onClick={onClick}
    className={`
      w-full py-4 rounded-2xl font-bold text-white shadow-[6px_6px_12px_#b8b9be,-6px_-6px_12px_#ffffff]
      bg-gradient-to-r from-emerald-400 to-teal-500 hover:from-emerald-500 hover:to-teal-600
      transform active:scale-95 transition-all duration-200 flex items-center justify-center gap-2
      ${className}
    `}
  >
    {Icon && <Icon size={20} />}
    {children}
  </button>
);

// --- Main Application ---

export default function LoanCalculator() {
  const [activeFields, setActiveFields] = useState(['principal', 'rate', 'tenure']);
  const [values, setValues] = useState({ principal: 5000000, rate: 8.5, tenure: 20, emi: 43391 });
  const [tenureType, setTenureType] = useState('years'); 
  const [interestType, setInterestType] = useState('fixed');
  const [activeTab, setActiveTab] = useState('calculator');
  const [isPdfLibraryLoaded, setIsPdfLibraryLoaded] = useState(false);
  
  const [extraEMI, setExtraEMI] = useState(5000);
  const [sipReturnRate, setSipReturnRate] = useState(12);

  const handleInputChange = (field, newValue) => {
    setValues(prev => ({ ...prev, [field]: newValue }));
    setActiveFields(prev => {
      if (prev.includes(field)) {
        const filtered = prev.filter(f => f !== field);
        return [...filtered, field];
      }
      const newActive = [...prev, field];
      return newActive.slice(1); 
    });
  };

  const calcTarget = useMemo(() => {
    const allFields = ['principal', 'rate', 'tenure', 'emi'];
    return allFields.find(f => !activeFields.includes(f));
  }, [activeFields]);

  useEffect(() => {
    const loadScript = (src) => {
      return new Promise((resolve, reject) => {
        if (document.querySelector(`script[src="${src}"]`)) { resolve(); return; }
        const script = document.createElement('script');
        script.src = src;
        script.async = false; 
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    };
    const initPdf = async () => {
      try {
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
        if (window.jspdf && window.jspdf.jsPDF && !window.jsPDF) { window.jsPDF = window.jspdf.jsPDF; }
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js');
        setIsPdfLibraryLoaded(true);
      } catch (err) { console.error("Failed to load PDF libraries", err); }
    };
    initPdf();
  }, []);

  const calculatedData = useMemo(() => {
    let P = parseFloat(values.principal) || 0;
    let R = parseFloat(values.rate) || 0;
    let N_val = parseFloat(values.tenure) || 0;
    let N_months = tenureType === 'years' ? N_val * 12 : N_val;
    let E = parseFloat(values.emi) || 0;
    
    if (calcTarget === 'principal') {
       const r = R / 12 / 100;
       if (r === 0) P = E * N_months; 
       else { const factor = Math.pow(1 + r, N_months); P = (E * (factor - 1)) / (r * factor); }
    } else if (calcTarget === 'tenure') {
      const r = R / 12 / 100;
      const interestOnly = P * r;
      if (E > interestOnly && E > 0 && P > 0) {
         const n = Math.log(E / (E - interestOnly)) / Math.log(1 + r); N_months = Math.ceil(n);
      } else { N_months = 0; }
    } else if (calcTarget === 'rate') {
       if (E * N_months > P && P > 0 && N_months > 0) {
         let low = 0, high = 100;
         for(let i=0; i<40; i++) {
           let mid = (low + high) / 2; let r_mid = mid / 12 / 100;
           let calc_E = (P * r_mid * Math.pow(1+r_mid, N_months)) / (Math.pow(1+r_mid, N_months) - 1);
           if (calc_E > E) high = mid; else low = mid;
         }
         R = high;
       } else { R = 0; }
    } else if (calcTarget === 'emi') {
       if (P > 0 && R >= 0 && N_months > 0) {
          const r = R / 12 / 100;
          if (r === 0) E = P / N_months;
          else E = (P * r * Math.pow(1 + r, N_months)) / (Math.pow(1 + r, N_months) - 1);
       } else { E = 0; }
    }

    if (P <= 0 || N_months <= 0 || E <= 0) return null;

    const totalPayment = E * N_months;
    const totalInterest = totalPayment - P;
    
    const schedule = [];
    let balance = P;
    const r = R / 12 / 100;
    const safeMonths = Math.min(N_months, 600); 
    for (let i = 1; i <= safeMonths; i++) {
      let interestComponent = balance * r;
      let principalComponent = E - interestComponent;
      if (i === safeMonths || balance - principalComponent < 0) { principalComponent = balance; balance = 0; } 
      else { balance -= principalComponent; }
      schedule.push({ month: i, emi: E, principalComponent, interestComponent, balance });
      if (balance <= 0.1) break; 
    }

    return { principal: P, rate: R, months: N_months, emi: E, totalPayment, totalInterest, schedule };
  }, [values, tenureType, calcTarget]);

  const analysisData = useMemo(() => {
    if (!calculatedData) return null;
    const sipMonthlyRate = (sipReturnRate / 12) / 100;
    const monthsOriginal = calculatedData.months;
    
    let foreclosureMonth = null;
    let interestPaidUntilForeclosure = 0;
    if (calculatedData.schedule) {
        for (let i = 0; i < calculatedData.schedule.length; i++) {
            const month = calculatedData.schedule[i].month;
            const loanBalance = calculatedData.schedule[i].balance;
            let fv = parseFloat(extraEMI) * ((Math.pow(1 + sipMonthlyRate, month) - 1) / sipMonthlyRate) * (1 + sipMonthlyRate);
            if (fv >= loanBalance) { 
              foreclosureMonth = month; 
              interestPaidUntilForeclosure = calculatedData.schedule.slice(0, i + 1).reduce((acc, row) => acc + row.interestComponent, 0);
              break; 
            }
        }
    }

    const duration = foreclosureMonth || monthsOriginal;
    const sipMaturity = parseFloat(extraEMI) * ((Math.pow(1 + sipMonthlyRate, duration) - 1) / sipMonthlyRate) * (1 + sipMonthlyRate);
    const totalInvested = parseFloat(extraEMI) * duration;
    const sipProfit = sipMaturity - totalInvested;
    const interestSaved = foreclosureMonth ? (calculatedData.totalInterest - interestPaidUntilForeclosure) : 0;

    let emiOpportunityValue = 0;
    let savedTenureMonths = 0;
    if (foreclosureMonth && foreclosureMonth < monthsOriginal) {
        savedTenureMonths = monthsOriginal - foreclosureMonth;
        if (calculatedData.emi > 0) {
           emiOpportunityValue = calculatedData.emi * ((Math.pow(1 + sipMonthlyRate, savedTenureMonths) - 1) / sipMonthlyRate) * (1 + sipMonthlyRate);
        }
    }

    return { maturity: sipMaturity, profit: sipProfit, invested: totalInvested, foreclosureMonth, interestSaved, emiOpportunityValue, savedTenureMonths };
  }, [calculatedData, extraEMI, sipReturnRate]);

  // --- Downloads ---
  const downloadCSV = () => {
    if (!calculatedData) return;
    const headers = ["Month", "Opening Balance", "EMI", "Principal", "Interest", "Closing Balance"];
    const rows = calculatedData.schedule.map((row, index) => {
      const prevBalance = index === 0 ? calculatedData.principal : calculatedData.schedule[index-1].balance;
      return [row.month, prevBalance.toFixed(2), row.emi.toFixed(2), row.principalComponent.toFixed(2), row.interestComponent.toFixed(2), row.balance.toFixed(2)].join(",");
    });
    const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows].join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "amortization_schedule.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const downloadPDF = () => {
    if (!calculatedData || !window.jspdf) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Helper to draw header on each page
    const drawHeader = (doc, pageNumber) => {
        const width = doc.internal.pageSize.getWidth();
        const height = doc.internal.pageSize.getHeight();
        
        if (pageNumber === 1) {
            // Big Header for Page 1
            doc.setFillColor(16, 185, 129); 
            doc.rect(0, 0, width, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.text("Qwecto", 14, 20);
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Smart Loan Report", 14, 28);
            doc.text(new Date().toLocaleDateString(), width - 14, 20, { align: "right" });

            // Executive Summary Box
            doc.setTextColor(60, 60, 60);
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("Loan Summary", 14, 50);

            const startY = 55;
            const boxH = 30;
            doc.setDrawColor(220, 220, 220);
            doc.setFillColor(248, 250, 252);
            doc.roundedRect(14, startY, width - 28, boxH, 3, 3, 'FD');

            doc.setFontSize(10);
            // Row 1
            doc.setTextColor(100);
            doc.text("Loan Amount", 20, startY + 8);
            doc.text("Interest Rate", 110, startY + 8);
            
            doc.setTextColor(0);
            doc.setFont("helvetica", "bold");
            doc.text(formatCurrency(calculatedData.principal), 20, startY + 14);
            doc.text(`${calculatedData.rate}% (${interestType})`, 110, startY + 14);

            // Row 2
            doc.setFont("helvetica", "normal");
            doc.setTextColor(100);
            doc.text("Tenure", 20, startY + 22);
            doc.text("Monthly EMI", 110, startY + 22);

            doc.setTextColor(0);
            doc.setFont("helvetica", "bold");
            doc.text(`${(calculatedData.months/12).toFixed(1)} Years`, 20, startY + 28);
            doc.text(formatCurrency(calculatedData.emi), 110, startY + 28);
        } else {
            // Small Header for Page 2+
            doc.setFillColor(240, 253, 244); 
            doc.rect(0, 0, width, 15, 'F');
            doc.setTextColor(16, 185, 129);
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("Qwecto - Loan Schedule (Cont.)", 14, 10);
            doc.setTextColor(100);
            doc.setFont("helvetica", "normal");
            doc.text(new Date().toLocaleDateString(), width - 14, 10, { align: "right" });
        }
        
        // Footer
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(`Page ${pageNumber}`, width / 2, height - 10, { align: "center" });
    };
    
    const annualRows = [];
    let yearPrincipal = 0; let yearInterest = 0; let yearTotal = 0; let currentYear = 1;
    calculatedData.schedule.forEach((row, index) => {
      yearPrincipal += row.principalComponent; yearInterest += row.interestComponent; yearTotal += row.emi;
      if ((index + 1) % 12 === 0 || index === calculatedData.schedule.length - 1) {
        annualRows.push([`Year ${currentYear}`, formatFullNumber(yearTotal), formatFullNumber(yearPrincipal), formatFullNumber(yearInterest), formatCurrency(row.balance)]);
        yearPrincipal = 0; yearInterest = 0; yearTotal = 0; currentYear++;
      }
    });

    doc.autoTable({ 
      startY: 95, // Start below the summary on page 1
      head: [["Period", "Total Paid", "Principal", "Interest", "Balance"]], 
      body: annualRows, 
      theme: 'grid', 
      headStyles: { fillColor: [16, 185, 129], textColor: 255, fontStyle: 'bold' }, 
      styles: { fontSize: 9, cellPadding: 3 }, 
      alternateRowStyles: { fillColor: [240, 253, 244] }, 
      margin: { top: 25, bottom: 20, left: 14, right: 14 }, // Adjusted margin for subsequent pages
      didDrawPage: (data) => { 
         drawHeader(doc, data.pageNumber);
      } 
    });
    
    doc.save("Qwecto_Loan_Report.pdf");
  };

  const DonutChart = () => {
    if (!calculatedData) return null;
    const principalPercent = (calculatedData.principal / calculatedData.totalPayment) * 100;
    const size = 160, strokeWidth = 20, radius = (size - strokeWidth) / 2;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (principalPercent / 100) * circumference;
    return (
      <div className="relative flex flex-col items-center justify-center">
        <svg width={size} height={size} className="transform -rotate-90">
          <circle cx={size / 2} cy={size / 2} r={radius} stroke="#e2e8f0" strokeWidth={strokeWidth} fill="transparent" />
          <circle cx={size / 2} cy={size / 2} r={radius} stroke="#818cf8" strokeWidth={strokeWidth} fill="transparent" />
          <circle cx={size / 2} cy={size / 2} r={radius} stroke="#4f46e5" strokeWidth={strokeWidth} fill="transparent" strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round" />
        </svg>
      </div>
    );
  };

  const AmortizationGraph = () => {
    if (!calculatedData || !calculatedData.schedule.length) return null;
    const [hoveredPoint, setHoveredPoint] = useState(null);
    const annualData = useMemo(() => {
        const groups = {};
        calculatedData.schedule.forEach(row => {
            const y = Math.ceil(row.month / 12);
            if (!groups[y]) groups[y] = { year: y, principal: 0, interest: 0 };
            groups[y].principal += row.principalComponent;
            groups[y].interest += row.interestComponent;
        });
        return Object.values(groups).sort((a, b) => a.year - b.year);
    }, [calculatedData]);
    if (annualData.length === 0) return null;
    const height = 200, width = 600, padding = 20;
    const graphWidth = width - padding * 2, graphHeight = height - padding * 2;
    const maxVal = Math.max(...annualData.map(d => d.principal), ...annualData.map(d => d.interest), 1) * 1.1; 
    const getCoords = (i, val) => {
      const divisor = annualData.length > 1 ? annualData.length - 1 : 1;
      const x = padding + (i / divisor) * graphWidth;
      const y = height - padding - (val / maxVal) * graphHeight;
      return { x: isNaN(x) ? 0 : x, y: isNaN(y) ? 0 : y };
    };
    const interestPoints = annualData.map((d, i) => { const { x, y } = getCoords(i, d.interest); return `${x},${y}`; }).join(' ');
    const principalPoints = annualData.map((d, i) => { const { x, y } = getCoords(i, d.principal); return `${x},${y}`; }).join(' ');

    return (
      <div className="mb-6 p-4 bg-white border border-slate-100 rounded-lg">
        <div className="flex items-center justify-between mb-4">
           <h4 className="text-sm font-bold text-slate-700">Annual Principal vs Interest Trend</h4>
           <div className="flex gap-3 text-xs">
              <div className="flex items-center gap-1"><div className="w-3 h-1 bg-rose-500 rounded-full"></div><span className="text-slate-500">Interest</span></div>
              <div className="flex items-center gap-1"><div className="w-3 h-1 bg-emerald-500 rounded-full"></div><span className="text-slate-500">Principal</span></div>
           </div>
        </div>
        <div className="w-full h-64 relative">
          <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible font-sans">
            <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#e2e8f0" strokeWidth="1" />
            <polyline points={interestPoints} fill="none" stroke="#f43f5e" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
            <polyline points={principalPoints} fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
            {annualData.map((d, index) => {
                const iCoord = getCoords(index, d.interest);
                const pCoord = getCoords(index, d.principal);
                return (
                  <g key={d.year}>
                    <rect x={pCoord.x - 10} y="0" width="20" height={height} opacity="0" onMouseEnter={() => setHoveredPoint({ ...d, px: pCoord.x })} onMouseLeave={() => setHoveredPoint(null)} className="cursor-pointer" />
                    <circle cx={pCoord.x} cy={pCoord.y} r="3.5" fill="white" stroke="#10b981" strokeWidth="2" className="pointer-events-none" />
                    <circle cx={iCoord.x} cy={iCoord.y} r="3.5" fill="white" stroke="#f43f5e" strokeWidth="2" className="pointer-events-none" />
                  </g>
                )
             })}
             {hoveredPoint && (
               <g transform={`translate(${hoveredPoint.px > width / 2 ? hoveredPoint.px - 210 : hoveredPoint.px + 10}, ${height/2 - 40})`}>
                 <foreignObject width="200" height="100">
                    <div className={`bg-slate-800 text-white text-xs p-2 rounded shadow-lg border border-slate-700 ${hoveredPoint.px > width / 2 ? 'text-right' : 'text-left'}`}>
                        <div className="font-bold mb-1 text-slate-300">{`Year ${hoveredPoint.year}`}</div>
                        <div className="flex justify-between gap-4"><span className="text-emerald-400">Principal:</span><span>{formatCurrency(hoveredPoint.principal)}</span></div>
                        <div className="flex justify-between gap-4"><span className="text-rose-400">Interest:</span><span>{formatCurrency(hoveredPoint.interest)}</span></div>
                    </div>
                 </foreignObject>
               </g>
             )}
          </svg>
        </div>
      </div>
    );
  };

  return (
    <NeumorphicLayout>
      <div className="w-full max-w-5xl">
        <div className="flex justify-between items-center mb-8 px-4">
          <h1 className="text-2xl font-bold text-slate-700 tracking-tight flex items-center gap-2">
            <div className="p-2 rounded-lg bg-[#E0E5EC] shadow-[4px_4px_8px_#b8b9be,-4px_-4px_8px_#ffffff]"><Calculator className="text-emerald-500" size={24} /></div>
            Qwecto
          </h1>
          <div className="flex bg-[#E0E5EC] rounded-2xl p-1.5 shadow-[inset_4px_4px_8px_#b8b9be,inset_-4px_-4px_8px_#ffffff]">
            {[{ id: 'calculator', icon: Home, label: 'Loan' }, { id: 'schedule', icon: Calendar, label: 'Schedule' }, { id: 'smartRepay', icon: Target, label: 'Smart Repay' }].map(tab => (
              <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-2 px-4 py-2 rounded-xl text-xs font-bold uppercase transition-all duration-300 ${activeTab === tab.id ? 'bg-[#E0E5EC] text-emerald-500 shadow-[4px_4px_8px_#b8b9be,-4px_-4px_8px_#ffffff]' : 'text-slate-400 hover:text-slate-500'}`}><tab.icon size={16} /><span className="hidden sm:inline">{tab.label}</span></button>
            ))}
          </div>
        </div>

        <NeumorphicCard className="overflow-hidden p-8">
          {activeTab === 'calculator' && (
            <div className="flex flex-col md:flex-row gap-12">
              <div className="w-full md:w-5/12 flex flex-col justify-center items-center relative">
                <div className="absolute top-0 left-0 w-full text-center md:text-left"><h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-1">{calcTarget === 'principal' ? 'Loan Amount' : 'Monthly Payment'}</h3></div>
                <div className="my-10 relative w-64 h-64 flex items-center justify-center">
                   <div className="w-56 h-56 rounded-full bg-[#E0E5EC] shadow-[12px_12px_24px_#b8b9be,-12px_-12px_24px_#ffffff] flex items-center justify-center relative">
                      <div className="w-40 h-40 rounded-full bg-[#E0E5EC] shadow-[inset_6px_6px_12px_#b8b9be,inset_-6px_-6px_12px_#ffffff] flex flex-col items-center justify-center p-4 text-center">
                         <span className="text-xs font-semibold text-slate-400 mb-1">Total Interest</span>
                         <span className="text-lg font-bold text-rose-400">{calculatedData ? formatFullNumber(calculatedData.totalInterest) : '-'}</span>
                      </div>
                      <svg className="absolute inset-0 w-full h-full rotate-[-90deg]" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="none" stroke="#E0E5EC" strokeWidth="8" />{calculatedData && (<circle cx="50" cy="50" r="45" fill="none" stroke="url(#gradient)" strokeWidth="4" strokeLinecap="round" strokeDasharray={`${(calculatedData.principal/calculatedData.totalPayment) * 283} 283`} />)}<defs><linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stopColor="#34d399" /><stop offset="100%" stopColor="#2dd4bf" /></linearGradient></defs></svg>
                   </div>
                </div>
                <div className="text-center"><span className="text-sm font-bold text-slate-400 uppercase">{calcTarget === 'principal' ? 'Maximum Loan' : 'EMI Amount'}</span><div className="text-5xl font-bold text-emerald-500 mt-2 tracking-tight drop-shadow-sm">{calculatedData ? (calcTarget === 'principal' ? formatFullNumber(calculatedData.principal) : formatCurrency(calculatedData.emi)) : '0'}</div></div>
              </div>
              <div className="w-full md:w-7/12 flex flex-col justify-center pl-0 md:pl-8 border-t md:border-t-0 md:border-l border-slate-200 pt-8 md:pt-0">
                <NeumorphicInput label="Loan Amount" value={calcTarget === 'principal' ? (calculatedData?.principal?.toFixed(0) || 0) : values.principal} onChange={(val) => handleInputChange('principal', val)} prefix="₹" isCalculated={calcTarget === 'principal'} onFocus={() => handleInputChange('principal', values.principal)} helperText={amountToWords(calcTarget === 'principal' ? calculatedData?.principal : values.principal)} />
                <div className="mb-5">
                  <div className="flex justify-between mb-2 px-1 items-end"><label className={`text-xs font-bold tracking-wider uppercase ${calcTarget === 'rate' ? 'text-emerald-500' : 'text-slate-500'}`}>Interest Rate {calcTarget === 'rate' && "(Auto)"}</label></div>
                  <div className="flex gap-4">
                    <div className="w-2/3"><div className={`relative flex items-center rounded-2xl px-4 py-3 transition-all ${calcTarget === 'rate' ? 'bg-[#E0E5EC] shadow-[5px_5px_10px_#b8b9be,-5px_-5px_10px_#ffffff] border border-emerald-100/50' : 'bg-[#E0E5EC] shadow-[inset_6px_6px_10px_0_rgba(163,177,198,0.7),inset_-6px_-6px_10px_0_rgba(255,255,255,0.8)]'}`}><input type="number" value={calcTarget === 'rate' ? (calculatedData?.rate?.toFixed(2) || 0) : values.rate} onChange={(e) => !calcTarget === 'rate' && handleInputChange('rate', e.target.value)} onFocus={() => handleInputChange('rate', values.rate)} readOnly={calcTarget === 'rate'} step={0.1} className={`w-full bg-transparent outline-none text-lg font-bold text-slate-700 ${calcTarget === 'rate' ? 'text-emerald-600 cursor-default' : ''}`} /><span className="text-slate-400 ml-2 text-sm font-medium">p.a</span></div></div>
                    <div className="w-1/3"><NeumorphicToggle options={[{label: 'Fixed', value: 'fixed'}, {label: 'Float', value: 'floating'}]} value={interestType} onChange={setInterestType} /></div>
                  </div>
                </div>
                <div className="mb-5">
                  <div className="flex justify-between mb-2 px-1 items-end"><label className={`text-xs font-bold tracking-wider uppercase ${calcTarget === 'tenure' ? 'text-emerald-500' : 'text-slate-500'}`}>Period {calcTarget === 'tenure' && "(Auto)"}</label></div>
                  <div className="flex gap-4">
                    <div className="w-2/3"><div className={`relative flex items-center rounded-2xl px-4 py-3 transition-all ${calcTarget === 'tenure' ? 'bg-[#E0E5EC] shadow-[5px_5px_10px_#b8b9be,-5px_-5px_10px_#ffffff] border border-emerald-100/50' : 'bg-[#E0E5EC] shadow-[inset_6px_6px_10px_0_rgba(163,177,198,0.7),inset_-6px_-6px_10px_0_rgba(255,255,255,0.8)]'}`}><input type="number" value={calcTarget === 'tenure' ? (tenureType === 'years' ? (calculatedData?.months / 12).toFixed(1) : calculatedData?.months) : values.tenure} onChange={(e) => handleInputChange('tenure', e.target.value)} readOnly={calcTarget === 'tenure'} onFocus={() => handleInputChange('tenure', values.tenure)} className={`w-full bg-transparent outline-none text-lg font-bold text-slate-700 ${calcTarget === 'tenure' ? 'text-emerald-600 cursor-default' : ''}`} /></div></div>
                    <div className="w-1/3"><NeumorphicToggle options={[{label: 'Yr', value: 'years'}, {label: 'Mo', value: 'months'}]} value={tenureType} onChange={setTenureType} /></div>
                  </div>
                </div>
                <NeumorphicInput label="EMI (Monthly)" value={calcTarget === 'emi' ? (calculatedData?.emi?.toFixed(0) || 0) : values.emi} onChange={(val) => handleInputChange('emi', val)} prefix="₹" isCalculated={calcTarget === 'emi'} onFocus={() => handleInputChange('emi', values.emi)} helperText={amountToWords(calcTarget === 'emi' ? calculatedData?.emi : values.emi)} />
                <div className="mt-4"><NeumorphicButton onClick={() => setActiveTab('schedule')}>View Schedule Detail</NeumorphicButton></div>
              </div>
            </div>
          )}

          {activeTab === 'schedule' && (
            <div className="animate-in fade-in duration-300">
              <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-slate-700">Amortization Schedule</h2><div className="flex gap-4"><div className="w-32"><NeumorphicButton onClick={downloadCSV} className="py-2 !text-xs"><FileText size={14} className="mr-1"/> CSV</NeumorphicButton></div><div className="w-32"><NeumorphicButton onClick={downloadPDF} className="py-2 !text-xs"><Download size={14} className="mr-1"/> PDF</NeumorphicButton></div></div></div>
              <div className="overflow-hidden rounded-2xl bg-[#E0E5EC] shadow-[inset_4px_4px_8px_#b8b9be,inset_-4px_-4px_8px_#ffffff] p-4"><div className="overflow-auto max-h-[400px]"><table className="w-full text-sm"><thead className="text-xs text-slate-400 uppercase border-b border-slate-300/50"><tr><th className="px-4 py-3 text-left">Year</th><th className="px-4 py-3 text-right">Principal</th><th className="px-4 py-3 text-right">Interest</th><th className="px-4 py-3 text-right">Balance</th></tr></thead><tbody className="divide-y divide-slate-200/50">{calculatedData?.schedule?.filter((_, i) => (i + 1) % 12 === 0 || i === calculatedData.schedule.length - 1).map((row) => (<tr key={row.month} className="hover:bg-white/40 transition-colors"><td className="px-4 py-3 font-bold text-slate-600">{Math.ceil(row.month / 12)}</td><td className="px-4 py-3 text-right text-emerald-600 font-medium">{formatCurrency(row.principalComponent)}</td><td className="px-4 py-3 text-right text-rose-500 font-medium">{formatCurrency(row.interestComponent)}</td><td className="px-4 py-3 text-right text-slate-500">{formatCurrency(row.balance)}</td></tr>))}</tbody></table></div></div>
              <div className="mt-6 p-6 rounded-2xl bg-[#E0E5EC] shadow-[6px_6px_12px_#b8b9be,-6px_-6px_12px_#ffffff] flex flex-col sm:flex-row items-center justify-between gap-4 border border-slate-100"><div className="flex items-start gap-3"><div className="p-3 rounded-full bg-indigo-100 text-indigo-600 shadow-inner mt-1"><Target size={20} /></div><div><h4 className="text-sm font-bold text-slate-700 uppercase tracking-wider">Recover Interest & Close Early</h4><p className="text-sm text-slate-500 mt-1">Start a SIP of <strong>{formatCurrency(extraEMI)}</strong> to potentially close this loan by <strong>Year {(analysisData?.foreclosureMonth/12).toFixed(1) || '-'}</strong>.</p></div></div><button onClick={() => setActiveTab('smartRepay')} className="px-6 py-3 rounded-xl font-bold text-white text-xs bg-indigo-500 shadow-[4px_4px_8px_#b8b9be,-4px_-4px_8px_#ffffff] hover:bg-indigo-600 transition-all active:scale-95">Analyze Smart Repay</button></div>
            </div>
          )}

          {activeTab === 'smartRepay' && (
            <div className="animate-in fade-in duration-300 flex flex-col md:flex-row gap-8">
               <div className="w-full md:w-1/3 space-y-6"><h3 className="text-lg font-bold text-slate-700 mb-4">Investment Strategy</h3><NeumorphicInput label="Monthly Surplus" value={extraEMI} onChange={setExtraEMI} prefix="₹" helperText={amountToWords(extraEMI)} /><NeumorphicInput label="Expected Return (%)" value={sipReturnRate} onChange={setSipReturnRate} suffix="%" /><div className="p-6 rounded-2xl bg-[#E0E5EC] shadow-[6px_6px_12px_#b8b9be,-6px_-6px_12px_#ffffff] text-xs text-slate-500 leading-relaxed"><strong className="block text-emerald-600 mb-2 text-sm">Why Smart Repay?</strong>Instead of prepaying the loan, investing your surplus in a high-return instrument (like Mutual Funds) can often generate enough wealth to close the loan years earlier.</div></div>
               <div className="w-full md:w-2/3">
                  {analysisData && (
                    <div className="flex flex-col h-full justify-center">
                        <div className="grid grid-cols-2 gap-6 mb-8"><div className="p-6 rounded-2xl bg-[#E0E5EC] shadow-[inset_4px_4px_8px_#b8b9be,inset_-4px_-4px_8px_#ffffff]"><span className="text-xs font-bold text-slate-400 uppercase block mb-2">Total Invested</span><span className="text-xl font-bold text-slate-700">{formatFullNumber(analysisData.invested)}</span></div><div className="p-6 rounded-2xl bg-[#E0E5EC] shadow-[inset_4px_4px_8px_#b8b9be,inset_-4px_-4px_8px_#ffffff] border-l-4 border-emerald-400"><span className="text-xs font-bold text-emerald-500 uppercase block mb-2">Profit Earned</span><span className="text-xl font-bold text-emerald-600">+{formatFullNumber(analysisData.profit)}</span></div></div>
                        <div className="flex justify-between items-center pt-4 border-t border-slate-100"><span className="text-slate-600 font-medium">Maturity Value</span><span className="text-2xl font-bold text-indigo-700">{formatCurrency(analysisData.maturity)}</span></div>
                        {analysisData.foreclosureMonth && (<div className="p-6 rounded-2xl bg-[#E0E5EC] shadow-[9px_9px_16px_rgb(163,177,198,0.6),-9px_-9px_16px_rgba(255,255,255,0.5)] flex items-center gap-4 mt-6"><div className="p-3 rounded-full bg-emerald-100 text-emerald-600 shadow-inner"><Clock size={24} /></div><div><h4 className="text-lg font-bold text-slate-700">Debt-Free by Year {(analysisData.foreclosureMonth/12).toFixed(1)}</h4><p className="text-sm text-slate-500 mt-1">Your investment corpus will exceed your loan balance by this time.<span className="block mt-1 font-bold text-emerald-600">You save {formatFullNumber(analysisData.interestSaved)} in interest!</span></p></div></div>)}
                        {analysisData.emiOpportunityValue > 0 && (<div className="mt-6 p-6 rounded-2xl bg-[#E0E5EC] shadow-[9px_9px_16px_rgb(163,177,198,0.6),-9px_-9px_16px_rgba(255,255,255,0.5)] border border-slate-200/50"><div className="flex items-center gap-3 mb-4"><div className="p-2 rounded-full bg-rose-100 text-rose-500 shadow-inner"><ArrowRightLeft size={20} /></div><h4 className="text-base font-bold text-slate-700">Opportunity Cost of EMI</h4></div><div className="flex justify-between items-end"><div><p className="text-xs text-slate-500 mb-1">Investing saved EMI for remaining {(analysisData.savedTenureMonths/12).toFixed(1)} Years:</p></div><span className="text-2xl font-bold text-rose-500">{formatCurrency(analysisData.emiOpportunityValue)}</span></div></div>)}
                    </div>
                  )}
               </div>
            </div>
          )}
        </NeumorphicCard>
      </div>
    </NeumorphicLayout>
  );
}